<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>RC Controller</title>

    <!-- alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- axios (shouldnt need this in prod) -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- leaflet css-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <!-- leaflet js -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&display=swap");
      :root {
        --font-light: #fefefe;
        --font-dark: #79797a;
        --font-mid: #b1b0b1;

        --bg-1: #101011;
        --bg-2: #1c1c1e;
        --bg-3: #373639;

        --highlight: #161c38;
      }
      * {
        font-family: "Kode Mono", monospace;
        box-sizing: border-box;
      }
    </style>

    <!-- alpine store -->
    <script>
      // default string displayed before things are loaded by the main loop
      const alt = "...";

      document.addEventListener("alpine:init", () => {
        Alpine.store("connections", {
          usb: alt,
          lora: alt,
        });

        Alpine.store("telemetry", {
          info: {
            Status: alt,
            Battery: alt,
            Speed: alt,
            Altitude: alt,
          },
        });

        Alpine.store("camera", {
          camStatus: alt,
        });
      });
    </script>
  </head>

  <!-- TODO: change the grid columns to scale properly -->
  <body
    class="overflow-hidden w-screen h-screen grid"
    style="grid-template-columns: 25vw 75vw"
  >
    <script defer>
      // main loop
      const updateInterval = 1000; // in ms

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function mainLoop() {
        /*
        Alpine.store("connections").lora = `${Math.floor(
          Math.random() * 101
        )}%`;
        */
      }

      // test
      async function takePhoto() {
        Alpine.store("camera").camStatus = "Capturing";
        await sleep(100);
        Alpine.store("camera").camStatus = "Photo taken";
        await sleep(500);
        Alpine.store("camera").camStatus = "Idle";
      }

      window.addEventListener("alpine:init", () => {
        setInterval(mainLoop, updateInterval);
      });
    </script>

    <!-- controls -->
    <div class="flex flex-col">
      <!-- connection status indicators -->
      <div
        id="connections"
        x-data
        class="bg-[var(--bg-1)] flex justify-between"
      >
        <div class="m-[10px] flex flex-col">
          <span class="m-0 p-0 text-[var(--font-dark)] text-xs">USB</span>
          <span
            x-text="$store.connections.usb"
            class="text-[var(--font-light)] text-md"
          ></span>
        </div>

        <div class="m-[10px] flex flex-col items-end">
          <span class="m-0 p-0 text-[var(--font-dark)] text-xs">LoRa</span>
          <span
            x-text="$store.connections.lora"
            class="text-[var(--font-light)] text-md"
          ></span>
        </div>
      </div>

      <!-- main panel -->
      <div
        class="bg-[var(--bg-2)] h-full flex flex-col items-center justify-between"
      >
        <!-- sensors & data grid -->
        <div class="grid grid-cols-2 grid-rows-2 w-full" id="telemetry" x-data>
          <template x-for="(value, label) in $store.telemetry.info">
            <div class="m-[10px] mb-0 flex flex-col">
              <span
                class="m-0 p-0 text-[var(--font-dark)] text-sm"
                x-text="label"
              ></span>
              <span
                x-text="value"
                class="text-[var(--font-light)] text-lg"
              ></span>
            </div>
          </template>
        </div>

        <!-- camera controls -->
        <div
          class="bg-[var(--bg-3)] rounded-md w-5/6 h-2/6 p-[2px] grid grid-cols-2"
          style="grid-template-rows: min-content 1fr"
          id="camera"
          x-data
        >
          <!-- top labels -->
          <span class="m-0 p-0 text-[var(--font-mid)] text-xs mb-[3px]"
            >Camera</span
          >
          <span
            class="m-0 p-0 text-[var(--font-mid)] text-xs text-right mb-[3px]"
            x-text="$store.camera.camStatus"
          ></span>

          <!-- actual buttons -->
          <div class="flex col-span-2">
            <button
              class="bg-[var(--bg-1)] w-1/3 rounded-md duration-[50ms] active:bg-[var(--highlight)] m-[1px] flex flex-col justify-center items-center"
              @click="takePhoto"
            >
              <!-- photo svg -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="var(--font-mid)"
                class="size-6"
              >
                <path
                  fill-rule="evenodd"
                  d="M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0 0 21 18v-1.94l-2.69-2.689a1.5 1.5 0 0 0-2.12 0l-.88.879.97.97a.75.75 0 1 1-1.06 1.06l-5.16-5.159a1.5 1.5 0 0 0-2.12 0L3 16.061Zm10.125-7.81a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Z"
                  clip-rule="evenodd"
                />
              </svg>

              <span class="text-[var(--font-light)] text-xs">Photo</span>
            </button>

            <button
              class="bg-[var(--bg-1)] w-1/3 rounded-md duration-[50ms] active:bg-[var(--highlight)] m-[2px] mt-[1px] mb-[1px] flex flex-col justify-center items-center"
            >
              <!-- video svg -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="var(--font-mid)"
                class="size-6"
              >
                <path
                  d="M4.5 4.5a3 3 0 0 0-3 3v9a3 3 0 0 0 3 3h8.25a3 3 0 0 0 3-3v-9a3 3 0 0 0-3-3H4.5ZM19.94 18.75l-2.69-2.69V7.94l2.69-2.69c.944-.945 2.56-.276 2.56 1.06v11.38c0 1.336-1.616 2.005-2.56 1.06Z"
                />
              </svg>

              <span class="text-[var(--font-light)] text-xs">Video</span>
            </button>

            <button
              class="bg-[var(--bg-1)] w-1/3 rounded-md duration-[50ms] active:bg-[var(--highlight)] m-[1px] flex flex-col justify-center items-center"
            >
              <!-- stop svg -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="var(--font-mid)"
                class="size-6"
              >
                <path
                  fill-rule="evenodd"
                  d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm6-2.438c0-.724.588-1.312 1.313-1.312h4.874c.725 0 1.313.588 1.313 1.313v4.874c0 .725-.588 1.313-1.313 1.313H9.564a1.312 1.312 0 0 1-1.313-1.313V9.564Z"
                  clip-rule="evenodd"
                />
              </svg>

              <span class="text-[var(--font-light)] text-xs">Stop</span>
            </button>
          </div>
        </div>

        <!-- relocate button -->
        <div
          class="bg-[var(--bg-3)] mb-[10px] w-5/6 rounded-md flex items-center"
        >
          <button
            class="bg-[var(--bg-1)] p-[12px] m-[3px] w-full rounded-md duration-[50ms] active:bg-[var(--highlight)] flex"
          >
            <!-- map pin icon -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="var(--font-mid)"
              class="size-6"
            >
              <path
                fill-rule="evenodd"
                d="m11.54 22.351.07.04.028.016a.76.76 0 0 0 .723 0l.028-.015.071-.041a16.975 16.975 0 0 0 1.144-.742 19.58 19.58 0 0 0 2.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 0 0-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 0 0 2.682 2.282 16.975 16.975 0 0 0 1.145.742ZM12 13.5a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"
                clip-rule="evenodd"
              />
            </svg>

            <span
              class="flex-1 text-[var(--font-light)] text-sm flex justify-center items-center"
              >Redirect</span
            >
          </button>
        </div>
      </div>
    </div>

    <!-- map -->
    <div id="map" x-init="mapInit()"></div>
    <script>
      function mapInit() {
        var map = L.map("map").setView([52.03142, 20.76578], 19);
        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }).addTo(map);
      }
    </script>
  </body>
</html>
